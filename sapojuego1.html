<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ App Mockup con Plataformer Minijuego</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: #1a202c; /* Fondo oscuro para el body */
            color: #e2e8f0; /* Color de texto claro */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ocupa al menos el 100% de la altura de la ventana */
            overflow: hidden; /* Prevent scrollbars */
        }
        /* Estilos base del frame del teléfono */
        .phone-frame {
            width: 375px;
            height: 700px;
            background-color: #1a202c;
            border-radius: 40px;
            box-shadow: 0 0 0 8px #2d3748,
                                 0 0 0 12px #1a202c,
                                 0 20px 50px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 25px;
            background-color: #1a202c;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            z-index: 10;
        }
        .speaker {
            width: 30px;
            height: 4px;
            background-color: #4a5568;
            border-radius: 2px;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 11;
        }
        .camera {
            width: 8px;
            height: 8px;
            background-color: #4a5568;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            left: calc(50% - 40px);
            z-index: 11;
        }
        /* Estilos específicos de la aplicación DJ */
        .dj-app-container {
            flex-grow: 1; /* Ocupa el espacio restante en el phone-frame */
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto; /* Permite scroll si el contenido excede la altura */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .dj-app-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }

        .deck {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .jog-wheel {
            width: 100px;
            height: 100px;
            background-color: #4a5568;
            border-radius: 50%;
            border: 5px solid #6b7280;
            position: relative;
            margin: 10px 0;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            color: #e2e8f0;
            user-select: none;
            transition: transform 0.1s ease-out; /* Smooth rotation visually */
        }
        .jog-wheel::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #a0aec0;
            border-radius: 50%;
            top: 10px; /* Indicator */
        }

        .controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }
        .control-button {
            background-color: #4299e1;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-button:hover {
            background-color: #3182ce;
        }

        .crossfader-container {
            width: 80%;
            margin: 20px auto;
            text-align: center;
        }
        .crossfader {
            width: 100%;
            height: 8px;
            background-color: #4a5568;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            cursor: pointer;
        }
        .crossfader::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background-color: #4299e1;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .crossfader::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background-color: #4299e1;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .bpm-slider-container {
            width: 100%;
            margin-top: 10px;
        }
        .bpm-slider {
            width: 100%;
            height: 6px;
            background-color: #4a5568;
            border-radius: 3px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            cursor: pointer;
        }
        .bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background-color: #6b7280;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .bpm-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background-color: #6b7280;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .beat-visualizer {
            width: 100%;
            height: 30px;
            background-color: #1a202c;
            border-radius: 5px;
            margin-top: 10px;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        .beat-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: #4a5568;
            height: 100%;
            margin-right: 2px; /* Small gap between bars */
            box-sizing: border-box;
            transition: background-color 0.1s ease-out;
        }
        .beat-bar.highlight {
            background-color: #4299e1; /* Highlight color */
        }
        .kick-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(66, 153, 225, 0.5); /* Blue glow */
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.05s ease-out;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .kick-pulse.active {
            opacity: 1;
        }

        /* Minigame Section */
        .minigame-container {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .game-canvas {
            background-color: #000;
            border-radius: 5px;
            margin-top: 10px;
            border: 2px solid #4a5568;
        }
        .game-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }
        .game-button {
            background-color: #48bb78; /* Green for game controls */
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .game-button:hover {
            background-color: #38a169;
        }
        .glow-effect {
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.7); /* Blue glow */
        }

        .kick-glow {
            box-shadow: 0 0 15px 5px rgba(66, 153, 225, 0.8); /* Stronger blue glow for kicks */
        }
        
        /* Visulizer Frame toggle styles */
        .visualization-frame {
            width: 100%;
            height: 150px; /* Fixed height for visualization */
            background-color: #000;
            border-radius: 5px;
            margin-top: 10px;
            border: 2px solid #4a5568;
            position: relative;
            overflow: hidden;
            display: none; /* Hidden by default */
        }
        .visualization-frame.active {
            display: block; /* Show when active */
        }

        /* Platformer game styles within visualization frame */
        #platformerCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="notch">
            <div class="speaker"></div>
            <div class="camera"></div>
        </div>
        
        <div class="dj-app-container">
            <h1 class="text-xl font-bold text-center mb-4">2Jog - Sapito v3</h1>
            <p class="text-sm text-center mb-4 text-gray-400">fmain debugmsg.html</p>

            <div class="deck">
                <h2 class="text-lg font-semibold" id="song-title-1">Track 1 - Default Song</h2>
                <div class="text-sm text-gray-400 mb-2">BPM: <span id="bpm-value-1">0.0</span></div>
                <div id="jog-wheel-1" class="jog-wheel">JOG</div>
                <div class="bpm-slider-container">
                    <input type="range" min="0.5" max="1.5" value="1" step="0.01" class="bpm-slider" id="bpm-slider-1">
                </div>
                <div class="controls">
                    <button class="control-button" id="play-pause-1">Play/Pause</button>
                    <button class="control-button" id="cue-1">Cue</button>
                    <button class="control-button" id="loop-8-1">Loop 8</button>
                </div>
                <div class="beat-visualizer" id="beat-visualizer-1">
                    <div class="beat-bars-wrapper" id="beat-bars-wrapper-1"></div>
                </div>
                <div class="kick-pulse" id="kick-pulse-1"></div>
            </div>

            <div class="deck">
                <h2 class="text-lg font-semibold" id="song-title-2">Track 2 - Default Song</h2>
                <div class="text-sm text-gray-400 mb-2">BPM: <span id="bpm-value-2">0.0</span></div>
                <div id="jog-wheel-2" class="jog-wheel">JOG</div>
                <div class="bpm-slider-container">
                    <input type="range" min="0.5" max="1.5" value="1" step="0.01" class="bpm-slider" id="bpm-slider-2">
                </div>
                <div class="controls">
                    <button class="control-button" id="play-pause-2">Play/Pause</button>
                    <button class="control-button" id="cue-2">Cue</button>
                    <button class="control-button" id="loop-8-2">Loop 8</button>
                </div>
                <div class="beat-visualizer" id="beat-visualizer-2">
                    <div class="beat-bars-wrapper" id="beat-bars-wrapper-2"></div>
                </div>
                <div class="kick-pulse" id="kick-pulse-2"></div>
            </div>

            <div class="crossfader-container">
                <label for="crossfader" class="text-sm mb-1">Crossfader</label>
                <input type="range" min="0" max="1" value="0.5" step="0.01" class="crossfader" id="crossfader">
            </div>

            <button class="game-button w-full mt-4 py-3" id="sync-button">
                Sync BPMs
            </button>

            <div class="minigame-container mt-4">
                <h2 class="text-lg font-semibold mb-2">Minijuego Plataformas</h2>
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <button class="game-button" id="toggle-visualization-frame">Toggle Visualizer</button>
                    <button class="game-button" id="minigame-start-button">Start Minigame</button>
                </div>
                
                <div class="visualization-frame" id="visualization-frame">
                    <canvas id="platformerCanvas"></canvas>
                </div>
                <div class="game-controls flex justify-around w-full">
                    <button class="game-button" id="jump-button">Jump</button>
                    <button class="game-button" id="left-button">Left</button>
                    <button class="game-button" id="right-button">Right</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default song data in case message fails or not enough songs
        const defaultSong1 = {
            id: 'default1',
            title: 'Default Track 1',
            artist: 'Default Artist',
            bpm: 128,
            genre: 'Electronic',
            url: 'https://raw.githubusercontent.com/DjLess/MP3_repo/main/default_beat_128bpm.mp3',
            songStructure: ["16k", "16b", "8k", "8b"] // Example structure
        };
        const defaultSong2 = {
            id: 'default2',
            title: 'Default Track 2',
            artist: 'Default Artist',
            bpm: 135,
            genre: 'Techno',
            url: 'https://raw.githubusercontent.com/DjLess/MP3_repo/main/default_beat_135bpm.mp3',
            songStructure: ["8k", "8b", "16k", "16b"] // Example structure
        };

        // Audio elements
        const audio1 = new Audio(defaultSong1.url);
        const audio2 = new Audio(defaultSong2.url);
        audio1.crossOrigin = "anonymous"; // Needed for Web Audio API if from different origin
        audio2.crossOrigin = "anonymous"; // Needed for Web Audio API if from different origin

        // Get UI elements
        const playPauseButton1 = document.getElementById('play-pause-1');
        const playPauseButton2 = document.getElementById('play-pause-2');
        const jogWheel1 = document.getElementById('jog-wheel-1');
        const jogWheel2 = document.getElementById('jog-wheel-2');
        const bpmSlider1 = document.getElementById('bpm-slider-1');
        const bpmSlider2 = document.getElementById('bpm-slider-2');
        const bpmValue1 = document.getElementById('bpm-value-1');
        const bpmValue2 = document.getElementById('bpm-value-2');
        const crossfader = document.getElementById('crossfader');
        const syncButton = document.getElementById('sync-button');
        const cueButton1 = document.getElementById('cue-1');
        const cueButton2 = document.getElementById('cue-2');
        const loop8Button1 = document.getElementById('loop-8-1');
        const loop8Button2 = document.getElementById('loop-8-2');
        const beatVisualizer1 = document.getElementById('beat-visualizer-1');
        const beatVisualizer2 = document.getElementById('beat-visualizer-2');
        const beatBarsWrapper1 = document.getElementById('beat-bars-wrapper-1');
        const beatBarsWrapper2 = document.getElementById('beat-bars-wrapper-2');
        const kickPulse1 = document.getElementById('kick-pulse-1');
        const kickPulse2 = document.getElementById('kick-pulse-2');

        // Minigame elements
        const toggleVisualizationFrameButton = document.getElementById('toggle-visualization-frame');
        const minigameStartButton = document.getElementById('minigame-start-button');
        const visualizationFrame = document.getElementById('visualization-frame');
        const platformerCanvas = document.getElementById('platformerCanvas');
        const jumpButton = document.getElementById('jump-button');
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');

        // Audio Context for Web Audio API features (e.g., crossfading, analysis)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const track1Source = audioContext.createMediaElementSource(audio1);
        const track2Source = audioContext.createMediaElementSource(audio2);

        // Gain nodes for crossfader
        const gainNode1 = audioContext.createGain();
        const gainNode2 = audioContext.createGain();

        track1Source.connect(gainNode1);
        track2Source.connect(gainNode2);
        gainNode1.connect(audioContext.destination);
        gainNode2.connect(audioContext.destination);

        // Initial crossfader position
        gainNode1.gain.value = 0.5;
        gainNode2.gain.value = 0.5;

        // Global variables for beat animation and tracking
        const BEAT_BAR_WIDTH = 15; // Width of each individual beat bar
        const BEAT_BAR_GAP = 2;    // Gap between beat bars
        const SUB_BEATS_PER_MAIN_BEAT = 4; // Number of sub-beats per main beat for visualizer
        let currentNumMainBeatsDisplayed1 = 8; // Default number of main beats to display initially
        let currentNumMainMainBeatsDisplayed2 = 8;

        let beatHighlightTimeouts1 = [];
        let beatHighlightTimeouts2 = [];
        let kickInterval1, kickInterval2; // For kick pulse animation

        let currentBeatIndex1 = 0;
        let currentBeatIndex2 = 0;
        let lastBeatTime1 = 0;
        let lastBeatTime2 = 0;

        let animationFrameId1 = null;
        let animationFrameId2 = null;

        // Jog wheel state
        const jogWheelState1 = {
            isDragging: false,
            lastX: 0,
            lastRotationTime: 0,
            animationFrameRotationId: null,
            currentRotation: 0, // In degrees
            initialRotation: 0, // Initial rotation when drag starts
            pitchBendInterval: null // For continuous pitch bend
        };
        const jogWheelState2 = {
            isDragging: false,
            lastX: 0,
            lastRotationTime: 0,
            animationFrameRotationId: null,
            currentRotation: 0,
            initialRotation: 0,
            pitchBendInterval: null
        };

        // Platformer game variables
        let player, platforms, obstacles, collectibles, enemies;
        let gameRunning = false;
        let gameAnimationFrameId;
        const GRAVITY = 0.5; // Reduced gravity
        const JUMP_VELOCITY = -10; // Reduced jump velocity
        const PLAYER_SPEED = 3; // Player horizontal speed
        const PLAYER_WIDTH = 20;
        const PLAYER_HEIGHT = 20;
        let playerX, playerY, playerVelY;
        let levelData = [];
        let currentLevel = 0;
        let gameScore = 0;
        let isPlayerOnGround = false;
        let lastKickBeatTime = 0; // For tracking kick beats for player jump
        let playerCanJumpFromKick = false;

        // Load default songs initially
        loadSong(defaultSong1, audio1, bpmValue1, bpmSlider1, beatBarsWrapper1, kickPulse1, 1);
        loadSong(defaultSong2, audio2, bpmValue2, bpmSlider2, beatBarsWrapper2, kickPulse2, 2);

        // --- Functions ---

        function loadSong(songData, audioElement, bpmValueElement, bpmSliderElement, beatBarsWrapper, kickPulseElement, deckNumber) {
            audioElement.src = songData.url;
            audioElement.load(); // Load the new source
            audioElement.playbackRate = 1.0; // Reset playback rate

            // Update UI
            document.getElementById(`song-title-${deckNumber}`).textContent = songData.title;
            bpmValueElement.textContent = songData.bpm.toFixed(1);
            
            setupBPMSlider(bpmSliderElement, songData.bpm);
            generateBeatBars(beatBarsWrapper, currentNumMainBeatsDisplayed1, SUB_BEATS_PER_MAIN_BEAT, beatVisualizer1.clientWidth); // Use fixed values for now, can adjust
            
            // Clear any old beat highlight timeouts
            const beatHighlightTimeouts = deckNumber === 1 ? beatHighlightTimeouts1 : beatHighlightTimeouts2;
            clearBeatHighlightTimeouts(beatHighlightTimeouts);

            // Reset beat tracking
            if (deckNumber === 1) {
                currentBeatIndex1 = 0;
                lastBeatTime1 = 0;
            } else {
                currentBeatIndex2 = 0;
                lastBeatTime2 = 0;
            }
        }

        function setupBPMSlider(slider, initialBPM) {
            // Set slider to represent current BPM correctly relative to playback rate
            slider.value = 1.0; // Reset to 1.0 (original speed)
            const updateBPM = () => {
                const newRate = parseFloat(slider.value);
                const actualBPM = initialBPM * newRate;
                slider.previousElementSibling.textContent = actualBPM.toFixed(1); // Update BPM display
                if (slider === bpmSlider1) {
                    audio1.playbackRate = newRate;
                } else {
                    audio2.playbackRate = newRate;
                }
            };
            slider.oninput = updateBPM;
            updateBPM(); // Call once to set initial display
        }

        function togglePlayPause(audio, button, bpmValueElement, beatBarsWrapper, beatHighlightTimeouts, animationFrameIdKey, numMainBeatsDisplayed) {
            if (audio.paused) {
                audioContext.resume().then(() => {
                    audio.play();
                    button.textContent = 'Pause';
                    if (audio === audio1) {
                        startBeatAnimationLoop(audio, bpmValueElement, beatBarsWrapper, beatHighlightTimeouts, animationFrameIdKey, numMainBeatsDisplayed);
                        kickInterval1 = startKickAnimationInterval(audio, kickPulse1, 'kickInterval1', parseFloat(bpmValueElement.textContent), onBeatJump);
                        jogWheelState1.lastRotationTime = performance.now();
                        jogWheelState1.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel1, jogWheelState1, ts));
                    } else {
                        startBeatAnimationLoop(audio, bpmValueElement, beatBarsWrapper, beatHighlightTimeouts, animationFrameIdKey, numMainBeatsDisplayed);
                        kickInterval2 = startKickAnimationInterval(audio, kickPulse2, 'kickInterval2', parseFloat(bpmValueElement.textContent), onBeatJump);
                        jogWheelState2.lastRotationTime = performance.now();
                        jogWheelState2.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel2, jogWheelState2, ts));
                    }
                });
            } else {
                audio.pause();
                button.textContent = 'Play';
                if (audio === audio1) {
                    clearBeatHighlightTimeouts(beatHighlightTimeouts1);
                    clearInterval(kickInterval1);
                    cancelAnimationFrame(jogWheelState1.animationFrameRotationId);
                } else {
                    clearBeatHighlightTimeouts(beatHighlightTimeouts2);
                    clearInterval(kickInterval2);
                    cancelAnimationFrame(jogWheelState2.animationFrameRotationId);
                }
            }
        }

        function setAudioVolume(audio, volume) {
            audio.volume = volume;
        }

        function updateCrossfaderVolume(value) {
            // value goes from 0 (all audio1) to 1 (all audio2)
            // track1 volume decreases as value increases
            // track2 volume increases as value increases
            gainNode1.gain.value = 1 - value;
            gainNode2.gain.value = value;

            // Apply glow effect based on active track
            if (value < 0.5) { // More of audio1
                jogWheel1.classList.add('glow-effect');
                jogWheel2.classList.remove('glow-effect');
            } else if (value > 0.5) { // More of audio2
                jogWheel1.classList.remove('glow-effect');
                jogWheel2.classList.add('glow-effect');
            } else { // Equal
                jogWheel1.classList.remove('glow-effect');
                jogWheel2.classList.remove('glow-effect');
            }
        }

        function generateBeatBars(wrapper, numMainBeats, subBeatsPerMainBeat, visualizerWidth) {
            wrapper.innerHTML = ''; // Clear existing bars
            const totalBars = numMainBeats * subBeatsPerMainBeat;
            // Calculate individual bar width to fill the visualizer
            const barWidth = (visualizerWidth - (totalBars - 1) * BEAT_BAR_GAP) / totalBars;
            
            for (let i = 0; i < totalBars; i++) {
                const beatBar = document.createElement('div');
                beatBar.classList.add('beat-bar');
                beatBar.style.width = `${barWidth}px`;
                // Make main beats slightly taller
                if (i % subBeatsPerMainBeat === 0) {
                    beatBar.style.height = '100%';
                } else {
                    beatBar.style.height = '60%'; // Sub-beat height
                }
                wrapper.appendChild(beatBar);
            }
            wrapper.style.display = 'flex'; // Ensure flexbox layout
            wrapper.style.width = '100%'; // Ensure wrapper takes full width
            wrapper.style.height = '100%';
            wrapper.style.alignItems = 'flex-end'; // Align bars to the bottom
            wrapper.style.justifyContent = 'space-between'; // Distribute bars evenly
        }

        function highlightBeatBar(wrapper, index, durationMs, timeoutsArray) {
            const bars = wrapper.children;
            if (bars[index]) {
                bars[index].classList.add('highlight');
                const timeout = setTimeout(() => {
                    bars[index].classList.remove('highlight');
                }, durationMs);
                timeoutsArray.push(timeout);
            }
        }

        function clearBeatHighlightTimeouts(timeoutsArray) {
            timeoutsArray.forEach(timeout => clearTimeout(timeout));
            timeoutsArray.length = 0; // Clear the array
            // Also remove highlight class from all bars
            const allBars = document.querySelectorAll('.beat-bar.highlight');
            allBars.forEach(bar => bar.classList.remove('highlight'));
        }

        function startBeatAnimationLoop(audio, bpmValueElement, beatBarsWrapper, beatHighlightTimeouts, animationFrameIdKey, numMainBeatsDisplayed) {
            const bpm = parseFloat(bpmValueElement.textContent);
            if (isNaN(bpm) || bpm <= 0) return;

            const msPerBeat = 60000 / (bpm * audio.playbackRate); // Adjusted for playback rate
            const totalBars = numMainBeatsDisplayed * SUB_BEATS_PER_MAIN_BEAT;
            const msPerBar = msPerBeat / SUB_BEATS_PER_MAIN_BEAT;

            const animate = (currentTime) => {
                if (audio.paused) return;

                const elapsedSinceLastBeat = currentTime - (audio === audio1 ? lastBeatTime1 : lastBeatTime2);

                if (elapsedSinceLastBeat >= msPerBar) {
                    const currentBeatIndex = (audio === audio1 ? currentBeatIndex1 : currentBeatIndex2);
                    highlightBeatBar(beatBarsWrapper, currentBeatIndex, msPerBar * 0.8, beatHighlightTimeouts);

                    if (audio === audio1) {
                        lastBeatTime1 = currentTime;
                        currentBeatIndex1 = (currentBeatIndex1 + 1) % totalBars;
                    } else {
                        lastBeatTime2 = currentTime;
                        currentBeatIndex2 = (currentBeatIndex2 + 1) % totalBars;
                    }
                }
                if (audio === audio1) {
                    animationFrameId1 = requestAnimationFrame(animate);
                } else {
                    animationFrameId2 = requestAnimationFrame(animate);
                }
            };

            // Initialize lastBeatTime when starting the loop
            if (audio === audio1) {
                lastBeatTime1 = performance.now();
            } else {
                lastBeatTime2 = performance.now();
            }
            if (audio === audio1) {
                if (animationFrameId1) cancelAnimationFrame(animationFrameId1); // Clear previous frame if any
                animationFrameId1 = requestAnimationFrame(animate);
            } else {
                if (animationFrameId2) cancelAnimationFrame(animationFrameId2);
                animationFrameId2 = requestAnimationFrame(animate);
            }
        }

        function startKickAnimationInterval(audioElement, kickPulseElement, intervalIdKey, bpm, onBeatJumpCallback) {
            const msPerBeat = 60000 / (bpm * audioElement.playbackRate);
            
            // Clear existing interval if any
            if (kickPulseElement.dataset.intervalId) {
                clearInterval(parseInt(kickPulseElement.dataset.intervalId));
            }

            const interval = setInterval(() => {
                if (!audioElement.paused) {
                    kickPulseElement.classList.add('active');
                    // Trigger player jump if within the kick window and game is running
                    if (gameRunning) {
                        onBeatJumpCallback();
                    }
                    setTimeout(() => {
                        kickPulseElement.classList.remove('active');
                    }, 100); // Pulse duration
                }
            }, msPerBeat);
            
            kickPulseElement.dataset.intervalId = interval.toString(); // Store interval ID on element
            return interval; // Return interval ID for clearing later
        }


        function updateJogWheelRotation(jogWheel, jogState, timestamp) {
            if (!jogState.isDragging && !jogState.animationFrameRotationId) return;

            const elapsed = timestamp - jogState.lastRotationTime;
            if (elapsed > 0) {
                // Decay rotation naturally if not dragging
                if (!jogState.isDragging) {
                    jogState.currentRotation *= Math.pow(0.95, elapsed / 16.67); // Decay factor
                    if (Math.abs(jogState.currentRotation) < 0.1) {
                        jogState.currentRotation = 0;
                        cancelAnimationFrame(jogState.animationFrameRotationId);
                        jogState.animationFrameRotationId = null;
                        return;
                    }
                }
                jogWheel.style.transform = `rotate(${jogState.currentRotation}deg)`;
            }
            jogState.lastRotationTime = timestamp;
            jogState.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel, jogState, ts));
        }

        function applyPitchBend(audio, originalBPM, bendDirection) {
            const bendFactor = 0.02; // 2% bend
            const currentPlaybackRate = audio.playbackRate;
            let newPlaybackRate = currentPlaybackRate;

            if (bendDirection === 'up') {
                newPlaybackRate = currentPlaybackRate * (1 + bendFactor);
            } else if (bendDirection === 'down') {
                newPlaybackRate = currentPlaybackRate * (1 - bendFactor);
            }

            // Limit bend to a reasonable range (e.g., +/- 10%)
            newPlaybackRate = Math.max(0.9, Math.min(1.1, newPlaybackRate));
            audio.playbackRate = newPlaybackRate;

            // Update BPM display
            const actualBPM = originalBPM * newPlaybackRate;
            if (audio === audio1) {
                bpmValue1.textContent = actualBPM.toFixed(1);
            } else {
                bpmValue2.textContent = actualBPM.toFixed(1);
            }
        }

        // --- Event Listeners ---

        playPauseButton1.addEventListener('click', () => togglePlayPause(audio1, playPauseButton1, bpmValue1, beatBarsWrapper1, beatHighlightTimeouts1, 'animationFrameId1', currentNumMainBeatsDisplayed1));
        playPauseButton2.addEventListener('click', () => togglePlayPause(audio2, playPauseButton2, bpmValue2, beatBarsWrapper2, beatHighlightTimeouts2, 'animationFrameId2', currentNumMainMainBeatsDisplayed2));

        crossfader.addEventListener('input', (e) => {
            updateCrossfaderVolume(parseFloat(e.target.value));
        });

        // Sync Button Logic
        syncButton.addEventListener('click', () => {
            if (audio1.paused || audio2.paused) {
                alert('Both tracks must be playing to sync BPMs.');
                return;
            }

            const bpm1 = parseFloat(bpmValue1.textContent);
            const bpm2 = parseFloat(bpmValue2.textContent);

            if (bpm1 === 0 || bpm2 === 0) {
                alert('BPMs not loaded for one or both tracks.');
                return;
            }

            // Determine which track to sync to (e.g., the one that started first or has higher volume)
            // For simplicity, let's sync audio2 to audio1's BPM
            const targetBPM = bpm1;
            const currentBPM2 = bpm2;

            if (currentBPM2 !== targetBPM) {
                const playbackRateAdjustment = targetBPM / currentBPM2;
                audio2.playbackRate *= playbackRateAdjustment;
                
                // Update slider and display for audio2
                const newSliderValue = parseFloat(bpmSlider2.value) * playbackRateAdjustment;
                bpmSlider2.value = newSliderValue.toFixed(2); // Keep 2 decimal places
                bpmValue2.textContent = (defaultSong2.bpm * audio2.playbackRate).toFixed(1);

                // Restart animation loops with new playback rate
                clearBeatHighlightTimeouts(beatHighlightTimeouts2);
                clearInterval(kickInterval2);
                cancelAnimationFrame(jogWheelState2.animationFrameRotationId);
                startBeatAnimationLoop(audio2, bpmValue2, beatBarsWrapper2, beatHighlightTimeouts2, 'animationFrameId2', currentNumMainMainBeatsDisplayed2);
                kickInterval2 = startKickAnimationInterval(audio2, kickPulse2, 'kickInterval2', parseFloat(bpmValue2.textContent), onBeatJump);
                jogWheelState2.lastRotationTime = performance.now();
                jogWheelState2.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel2, jogWheelState2, ts));

                console.log(`Synced Track 2 BPM to Track 1 (${targetBPM.toFixed(1)})`);
            } else {
                console.log('BPMs are already synced.');
            }
        });


        // Jog Wheel Functionality
        const setupJogWheel = (jogWheel, audio, jogState, bpmValueElement, defaultSong) => {
            let initialMouseX = 0;

            jogWheel.addEventListener('mousedown', (e) => {
                jogState.isDragging = true;
                initialMouseX = e.clientX;
                jogState.initialRotation = jogState.currentRotation; // Store initial rotation
                jogWheel.style.cursor = 'grabbing';
                // Start continuous pitch bend
                const bpm = parseFloat(bpmValueElement.textContent);
                if (audio.paused) audio.play(); // Start playing if not
                jogState.pitchBendInterval = setInterval(() => {
                    if (jogState.isDragging) {
                        const deltaX = e.clientX - initialMouseX;
                        if (deltaX > 0) { // Dragging right (forward)
                            applyPitchBend(audio, defaultSong.bpm, 'up');
                        } else if (deltaX < 0) { // Dragging left (backward)
                            applyPitchBend(audio, defaultSong.bpm, 'down');
                        } else {
                            // If no horizontal movement, stop bending
                            clearInterval(jogState.pitchBendInterval);
                            jogState.pitchBendInterval = null;
                            audio.playbackRate = 1.0; // Reset to original
                            bpmValueElement.textContent = defaultSong.bpm.toFixed(1);
                        }
                    }
                }, 50); // Adjust bend every 50ms

                // If animation not running, start it
                if (!jogState.animationFrameRotationId) {
                    jogState.lastRotationTime = performance.now();
                    jogState.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel, jogState, ts));
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!jogState.isDragging) return;

                const deltaX = e.clientX - initialMouseX;
                const rotationAmount = deltaX * 0.5; // Adjust sensitivity
                jogState.currentRotation = jogState.initialRotation + rotationAmount;

                // Scrubbing audio
                if (!audio.paused) {
                    const scrubSpeed = deltaX * 0.0005; // Adjust scrub sensitivity
                    audio.currentTime = Math.max(0, Math.min(audio.duration, audio.currentTime + scrubSpeed));
                }
            });

            document.addEventListener('mouseup', () => {
                if (jogState.isDragging) {
                    jogState.isDragging = false;
                    jogWheel.style.cursor = 'grab';
                    if (jogState.pitchBendInterval) {
                        clearInterval(jogState.pitchBendInterval);
                        jogState.pitchBendInterval = null;
                        audio.playbackRate = 1.0; // Reset playback rate on release
                        bpmValueElement.textContent = defaultSong.bpm.toFixed(1); // Reset BPM display
                    }
                }
            });
        };

        setupJogWheel(jogWheel1, audio1, jogWheelState1, bpmValue1, defaultSong1);
        setupJogWheel(jogWheel2, audio2, jogWheelState2, bpmValue2, defaultSong2);

        // --- CUE and Loop functionality (placeholders for now) ---
        cueButton1.addEventListener('click', () => {
            audio1.currentTime = 0; // Go to start
            audio1.play(); // Start playing from cue point
            playPauseButton1.textContent = 'Pause';
            // Optionally, save the current position as a cue point
        });
        cueButton2.addEventListener('click', () => {
            audio2.currentTime = 0;
            audio2.play();
            playPauseButton2.textContent = 'Pause';
        });

        loop8Button1.addEventListener('click', () => {
            // For an 8-beat loop, you need song BPM to calculate loop duration
            const currentBPM = parseFloat(bpmValue1.textContent);
            if (currentBPM === 0 || audio1.paused) {
                alert('Play track 1 and ensure BPM is loaded to set a loop.');
                return;
            }
            const loopDurationSeconds = (60 / currentBPM) * 8; // Duration of 8 beats
            const loopStartTime = audio1.currentTime;
            const loopEndTime = loopStartTime + loopDurationSeconds;

            if (loopEndTime > audio1.duration) {
                alert('8-beat loop would go beyond end of track. Shortening loop.');
                // Optionally adjust loop end or warn user
            }

            audio1.loop = true; // Enable HTML5 audio loop property
            audio1.addEventListener('timeupdate', function loopCheck() {
                if (audio1.currentTime >= loopEndTime) {
                    audio1.currentTime = loopStartTime;
                }
            });
            alert(`Looping 8 beats from ${loopStartTime.toFixed(2)}s for ${loopDurationSeconds.toFixed(2)}s`);
        });

        loop8Button2.addEventListener('click', () => {
            const currentBPM = parseFloat(bpmValue2.textContent);
            if (currentBPM === 0 || audio2.paused) {
                alert('Play track 2 and ensure BPM is loaded to set a loop.');
                return;
            }
            const loopDurationSeconds = (60 / currentBPM) * 8;
            const loopStartTime = audio2.currentTime;
            const loopEndTime = loopStartTime + loopDurationSeconds;

            if (loopEndTime > audio2.duration) {
                alert('8-beat loop would go beyond end of track. Shortening loop.');
            }

            audio2.loop = true;
            audio2.addEventListener('timeupdate', function loopCheck() {
                if (audio2.currentTime >= loopEndTime) {
                    audio2.currentTime = loopStartTime;
                }
            });
            alert(`Looping 8 beats from ${loopStartTime.toFixed(2)}s for ${loopDurationSeconds.toFixed(2)}s`);
        });

        // --- Platformer Minigame Logic ---
        const ctx = platformerCanvas.getContext('2d');
        const GAME_WIDTH = 350;
        const GAME_HEIGHT = 150; // Fixed height of visualization frame

        platformerCanvas.width = GAME_WIDTH;
        platformerCanvas.height = GAME_HEIGHT;

        function initializePlatformGame() {
            playerX = 50;
            playerY = GAME_HEIGHT - PLAYER_HEIGHT - 10; // Start above ground
            playerVelY = 0;
            gameScore = 0;
            isPlayerOnGround = false;

            // Define some simple level data
            levelData = [
                // Format: [x, y, width, height]
                { x: 0, y: GAME_HEIGHT - 10, width: GAME_WIDTH, height: 10, type: 'platform' }, // Ground
                { x: 100, y: GAME_HEIGHT - 50, width: 80, height: 10, type: 'platform' },
                { x: 250, y: GAME_HEIGHT - 80, width: 60, height: 10, type: 'platform' },
                { x: 50, y: GAME_HEIGHT - 120, width: 70, height: 10, type: 'platform' }
            ];

            platforms = levelData.filter(obj => obj.type === 'platform');
            obstacles = []; // Add obstacles later if needed
            collectibles = []; // Add collectibles later if needed
            enemies = []; // Add enemies later if needed

            // Update player display
            drawGame();
            gameRunning = true;
            if (gameAnimationFrameId) cancelAnimationFrame(gameAnimationFrameId);
            gameAnimationFrameId = requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT); // Clear canvas

            // Draw player
            ctx.fillStyle = 'blue';
            ctx.fillRect(playerX, playerY, PLAYER_WIDTH, PLAYER_HEIGHT);

            // Draw platforms
            ctx.fillStyle = 'green';
            platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });

            // Display score (if applicable)
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(`Score: ${gameScore}`, 10, 20);
        }

        function gameLoop() {
            if (!gameRunning) return;

            // Apply gravity
            playerVelY += GRAVITY;
            playerY += playerVelY;

            isPlayerOnGround = false;
            // Platform collision detection
            platforms.forEach(platform => {
                if (playerX < platform.x + platform.width &&
                    playerX + PLAYER_WIDTH > platform.x &&
                    playerY + PLAYER_HEIGHT > platform.y &&
                    playerY + PLAYER_HEIGHT < platform.y + platform.height + playerVelY) { // Check if falling onto platform
                    
                    playerY = platform.y - PLAYER_HEIGHT; // Place on top of platform
                    playerVelY = 0;
                    isPlayerOnGround = true;
                }
            });

            // Prevent falling through bottom (ground)
            if (playerY + PLAYER_HEIGHT > GAME_HEIGHT - 10) {
                playerY = GAME_HEIGHT - 10 - PLAYER_HEIGHT;
                playerVelY = 0;
                isPlayerOnGround = true;
            }

            drawGame();
            gameAnimationFrameId = requestAnimationFrame(gameLoop);
        }

        function playerJump() {
            if (isPlayerOnGround) {
                playerVelY = JUMP_VELOCITY;
                isPlayerOnGround = false;
            }
        }

        function movePlayer(direction) {
            if (direction === 'left') {
                playerX -= PLAYER_SPEED;
            } else if (direction === 'right') {
                playerX += PLAYER_SPEED;
            }
            // Keep player within canvas bounds
            playerX = Math.max(0, Math.min(GAME_WIDTH - PLAYER_WIDTH, playerX));
        }

        function onBeatJump() {
            // Trigger player jump on kick beat if the player is on the ground
            // This needs to be carefully managed to avoid multiple jumps per beat
            if (isPlayerOnGround && gameRunning) {
                playerCanJumpFromKick = true; // Signal that a jump is possible
            }
        }

        // --- Game Controls Listeners ---
        jumpButton.addEventListener('click', playerJump);
        leftButton.addEventListener('click', () => movePlayer('left'));
        rightButton.addEventListener('click', () => movePlayer('right'));

        // Keyboard controls for convenience
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            switch (e.key) {
                case 'ArrowUp':
                case ' ' : // Spacebar
                    playerJump();
                    break;
                case 'ArrowLeft':
                    movePlayer('left');
                    break;
                case 'ArrowRight':
                    movePlayer('right');
                    break;
            }
        });

        // Toggle Visualization Frame
        toggleVisualizationFrameButton.addEventListener('click', () => {
            if (visualizationFrame.classList.contains('active')) {
                visualizationFrame.classList.remove('active');
                gameRunning = false;
                if (gameAnimationFrameId) cancelAnimationFrame(gameAnimationFrameId);
            } else {
                visualizationFrame.classList.add('active');
                // Only initialize game if not already running or starting fresh
                if (!gameRunning) {
                    initializePlatformGame();
                }
            }
        });

        // Start Minigame Button
        minigameStartButton.addEventListener('click', () => {
            // Ensure visualization frame is active before starting
            if (!visualizationFrame.classList.contains('active')) {
                visualizationFrame.classList.add('active');
            }
            initializePlatformGame();
        });

        // --- Game Logic Integration with Audio ---
        // This function will be called repeatedly to check for synced kicks and allow player to jump
        function checkSyncedKicks() {
            // This function is meant to be called in a loop (e.g., via requestAnimationFrame)
            // It should check if both audios are playing and if their kicks are aligned.
            // For the minigame, we are interested if a kick just happened to allow a jump.

            if (gameRunning && playerCanJumpFromKick) {
                // If a kick beat just occurred and the player is on the ground,
                // allow a jump. Reset the flag immediately after.
                playerJump();
                playerCanJumpFromKick = false;
            }
            // Continue the loop
            requestAnimationFrame(checkSyncedKicks);
        }

        function updateAllPlatformDynamics() {
            // This function would be called when BPMs change or sync happens
            // to adjust game speed, obstacle generation etc., based on current song BPM.
            // For now, it's a placeholder.
            console.log('Platform dynamics updated based on new music data.');
        }


        // --- Event Listener for Incoming Messages (Crucial for this problem) ---
        window.addEventListener('message', (event) => {
            // IMPORTANT: Replace "YOUR_MAIN_APP_ORIGIN" with the actual origin of your main screen.
            // For example, if your main screen is served from http://localhost:8000, use "http://localhost:8000".
            // If it's a file on your local system, you might need to test with "null" during development,
            // but it's crucial to set a specific origin in deployment for security.
            const trustedOrigin = "YOUR_MAIN_APP_ORIGIN"; // E.g., "http://localhost:8000" or "https://your-main-app-domain.com"

            // For local file testing, event.origin might be "null" or "file://".
            // Be cautious with "null" in production as it can be spoofed.
            if (event.origin !== trustedOrigin && event.origin !== "null") { // Added "null" check for local file system testing
                console.warn('Message received from untrusted origin:', event.origin);
                return; // Ignore messages from untrusted sources
            }

            // Ensure event.data is an object and has a 'type' property
            if (typeof event.data !== 'object' || event.data === null || !event.data.type) {
                console.warn('Received invalid message data:', event.data);
                return;
            }

            if (event.data.type === 'musicData') {
                console.log('Received music data message:', event.data); // Log the full event.data for debugging
                const musicData = event.data.payload;

                // Robust validation of the payload
                if (Array.isArray(musicData) && musicData.length >= 2) {
                    // Ensure the individual song objects exist within the first payload element
                    if (musicData[0] && musicData[0].audio1 && musicData[0].audio2) {
                        const song1 = musicData[0].audio1;
                        const song2 = musicData[0].audio2;

                        console.log('Successfully extracted song1:', song1.title);
                        console.log('Successfully extracted song2:', song2.title);

                        // Update UI elements with song titles
                        document.getElementById('song-title-1').textContent = song1.title;
                        document.getElementById('song-title-2').textContent = song2.title;
                        bpmValue1.textContent = song1.bpm.toFixed(1);
                        bpmValue2.textContent = song2.bpm.toFixed(1);

                        // Update the audio sources and load them
                        audio1.src = song1.url;
                        audio2.src = song2.url;
                        audio1.load();
                        audio2.load();

                        // Update BPM sliders based on new song BPMs
                        setupBPMSlider(bpmSlider1, song1.bpm);
                        setupBPMSlider(bpmSlider2, song2.bpm);

                        // Re-generate beat bars for new songs
                        generateBeatBars(beatBarsWrapper1, currentNumMainBeatsDisplayed1, SUB_BEATS_PER_MAIN_BEAT, beatVisualizer1.clientWidth);
                        generateBeatBars(beatBarsWrapper2, currentNumMainMainBeatsDisplayed2, SUB_BEATS_PER_MAIN_BEAT, beatVisualizer2.clientWidth);

                        // Clear previous timeouts before starting new ones to prevent overlap
                        clearBeatHighlightTimeouts(beatHighlightTimeouts1);
                        clearBeatHighlightTimeouts(beatHighlightTimeouts2);
                        cancelAnimationFrame(animationFrameId1); // Clear previous animation frames
                        cancelAnimationFrame(animationFrameId2);

                        // Re-initialize beat tracking related variables if they are per-song
                        currentBeatIndex1 = 0;
                        currentBeatIndex2 = 0;
                        lastBeatTime1 = 0;
                        lastBeatTime2 = 0;

                        // Only start animations if audio is not paused (or if you intend to auto-play)
                        // Note: Browsers often prevent autoplay without user interaction.
                        if (!audio1.paused) {
                            startBeatAnimationLoop(audio1, bpmValue1, beatBarsWrapper1, beatHighlightTimeouts1, 'animationFrameId1', currentNumMainBeatsDisplayed1);
                            startKickAnimationInterval(audio1, kickPulse1, 'kickInterval1', parseFloat(bpmValue1.textContent), onBeatJump);
                            jogWheelState1.lastRotationTime = performance.now();
                            jogWheelState1.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel1, jogWheelState1, ts));
                        }
                        if (!audio2.paused) {
                            startBeatAnimationLoop(audio2, bpmValue2, beatBarsWrapper2, beatHighlightTimeouts2, 'animationFrameId2', currentNumMainMainBeatsDisplayed2);
                            startKickAnimationInterval(audio2, kickPulse2, 'kickInterval2', parseFloat(bpmValue2.textContent), onBeatJump);
                            jogWheelState2.lastRotationTime = performance.now();
                            jogWheelState2.animationFrameRotationId = requestAnimationFrame((ts) => updateJogWheelRotation(jogWheel2, jogWheelState2, ts));
                        }
                        updateAllPlatformDynamics(); // Update game dynamics after new songs are loaded
                    } else {
                        console.warn('Received music data message, but song objects (audio1/audio2) are missing or malformed in the first payload element. Using defaults.');
                    }
                } else {
                    console.warn('Received music data for Sapito Game, but payload is not a valid array or does not contain enough songs (expected >= 2 elements). Payload received:', musicData, 'Using defaults.');
                }
            } else {
                console.log('Received non-musicData message type:', event.data.type);
            }
        });

        // Initial call to checkSyncedKicks to start the continuous check
        // Moved to window.onload for full page readiness
        // Initial crossfader dispatch to set initial volumes and glows
        // Moved to window.onload for full page readiness

        // Initial setup on window load
        window.onload = () => {
            // Initial setup for DJ app elements
            checkSyncedKicks(); // Start the continuous sync check loop
            crossfader.dispatchEvent(new Event('input'));
            // No need to call initializePlatformGame here, it's called when visualization frame is toggled or minigame start button is clicked
        };
    </script>
</body>
</html>
